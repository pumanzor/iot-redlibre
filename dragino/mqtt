#include <Process.h>
#include "MQTTclient.h"
#include "DHT.h"
#include <OneWire.h> //Se importan las librer√≠as
#include <DallasTemperature.h>

#define ONE_WIRE_BUS_PIN 3
float  tempC2 = 0;
float  tempC3 = 0;

OneWire oneWire(ONE_WIRE_BUS_PIN);
DallasTemperature sensors(&oneWire);
DeviceAddress probe01 =  {0x28, 0xC7, 0xEB, 0xF0, 0x05, 0x00, 0x00, 0xEA};
DeviceAddress probe02 =  {0x28, 0x82, 0x2F, 0xF1, 0x05, 0x00, 0x00, 0xC6};

#define MQTT_HOST "190.97.168.236" 
#define DHTPIN A0     
//#define DHTPIN2 A1

#define DHTTYPE DHT22   // DHT 22  (AM2302)
DHT dht(DHTPIN, DHTTYPE);
//DHT dht2(DHTPIN2, DHTTYPE);


char message_buff[100];
char message_buff2[100];
String id_sensor = "test@redlibre.cl";
String id_sensor2 = "test2@redlibre.cl";
int led = 4;
//int led2 = 3 ;
int led3 = 2; 
unsigned long time;
float t2;

void setup() {
    
  // start serial
  Serial.begin(9600);
  // remember the bridge!
  Bridge.begin();
  // begin the client library (initialize host)
  mqtt.begin(MQTT_HOST, 1883);
  dht.begin();
  //dht2.begin();
  sensors.begin(); //Se inician los sensores
  sensors.setResolution(probe01, 10);
    sensors.setResolution(probe02, 10);
  pinMode(led, OUTPUT);
 // pinMode(led2, OUTPUT);
  pinMode(led3, OUTPUT);
  
  mqtt.subscribe("test/uno", someEvent);


}

/*void printTemperature(DeviceAddress deviceAddress)
{

float tempC = sensors.getTempC(deviceAddress);

   if (tempC == -127.00) 
   {
   Serial.print("Error getting temperature  ");
   } 
   else
   {
   Serial.print("C: ");
   Serial.print(tempC);
   Serial.print(" F: ");
   Serial.print(DallasTemperature::toFahrenheit(tempC));
   }
}

*/

void loop() {
  float h = dht.readHumidity();
  float t = dht.readTemperature();

 // float h2 = dht2.readHumidity();
  //float t2 = dht2.readTemperature();

 sensors.requestTemperatures();
 tempC2 = sensors.getTempC(probe01);
  tempC3 = sensors.getTempC(probe02);
 
   if (millis() > (time + 30000)) {
       time = millis();
  
  String pubString = "" + String(t) + " ," + String(h) + " ," + id_sensor + "" ;
   pubString.toCharArray(message_buff, pubString.length()+1);
        
   String pubString2= "" + String(tempC2) + " ," + String(tempC3) + " ," + id_sensor2 + "" ;
    pubString2.toCharArray(message_buff2, pubString2.length()+1);    
        
       mqtt.publish("test/temp",message_buff );
       mqtt.publish("test/temp",message_buff2 );

   }
   else{
   
  mqtt.monitor();
   }
}

// use callback function to work with your messages
void someEvent(const String& topic, const String& subtopic, const String& message) {
  
  // print the topic and message
  Serial.print("topic: ");
  Serial.println(topic);
  Serial.print("message: "); 
  Serial.println(message); 
  
  //int integer = 25;
 // String integer = hola;
  // publish an integer to a test topic
  mqtt.publish("test/dos", "Recibido_Control_D1");
   if (message == "s3up") {
    digitalWrite(led, HIGH);
   
  } //else if (message == "s2up"){
    //digitalWrite(led2, HIGH);
    
  //} 
  else if (message == "s3down"){
    digitalWrite(led, LOW);
    
  } //else if (message == "s2down"){
    //digitalWrite(led2, LOW);
    
 // } 
 else if (message == "s21up"){
    digitalWrite(led3, HIGH);
    
  }  else if (message == "s21down"){
    digitalWrite(led3, LOW);
    
  } 
  
}
